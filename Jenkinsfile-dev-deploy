pipeline {
  agent any

  environment {
    DOCKERHUB_CREDENTIALS = credentials('dockerhub')
    ARGO_CREDENTIALS = credentials('argocd')
    ARGO_SERVER = 'argocd-server.argocd.svc.cluster.local:443'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Sync Argo CD') {
      when {
        expression { fileExists('argocd-dev.yaml') }
      }
      steps {
        sh """
          argocd login \$ARGO_SERVER --username \$ARGO_CREDENTIALS_USR --password \$ARGO_CREDENTIALS_USR --insecure
          argocd app sync petclinic-dev
        """
      }
    }
  }
}
